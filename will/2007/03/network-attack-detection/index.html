<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Network Attack Detection</title>
   <meta name="author" content="Will Mernagh" />
   <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/wmernagh" />
   <link rel="stylesheet" href="/css/styles.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
   <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
   <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
   <script type="text/javascript" src="/javascript/jquery.boastful.js"></script>
   <script type="text/javascript">
     $(document).ready(function() {
        $('#boastful').boastful()
     });
   </script>
</head>
<body>
	
	<div id="header">
	  <a href="/">
	    <img src="http://en.gravatar.com/userimage/944395/c4f6f5602305ebe2cac41ddfc165782d.png" height="48" width="48" class="avatar" />
	  </a>
	  <div id="bio">
	    <div id="title"><a href="/will">Will Mernagh</a></div>
	    <div class="byline separation">
	      I work at <a href="http://iorahealth.com">Iora Health</a>.<br />
	      I am a <a href="http://www.cs.tufts.edu">Tufts</a> and
	      <a href="http://www.cit.ie">CIT</a> Alum.<br />
	    </div>
	    <div class="byline separation">
	      I'm <a href="http://twitter.com/im_a_muppet">@im_a_muppet</a> on Twitter.<br />
	      I'm <a href="http://github.com/wmernagh">@wmernagh</a> on GitHub.<br />
          <br/>
	      Will and Orla's <a href="/photos/">photo</a> page<br />
	      Back to <a href="/">WillAndOrla.com</a><br />
	    </div>
    <div class="byline contact">
      <a href="/will/about">about</a>
      <a
      href="mailto:&#119;&#109;&#101;&#114;&#110;&#097;&#103;&#104;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">contact</a>
      <a href="https://github.com/wmernagh/blog">fork</a>
    </div>
  </div>
</div>

<div class="content">
  <div id="post">
  <h1>
  <a href="/2007/03/network-attack-detection">Network Attack Detection</a>
</h1>
<div class="authoring">
  by @<a href="http://twitter.com/im_a_muppet">im_a_muppet</a> on March 16, 2007
</div>
  <p>For this assignment we were to modify the scavenger program to read a trace file and detect what type of attack is taking place over the network (if any).<br />
<a href="/cs/pa3.pdf" title="PA3"></a></p>
<p><a href="/cs/pa3.pdf" title="PA3">PA3</a> the assignment. <a href="/cs/attackalarm.tar.gz" title="(Project Files)">(project files)</a></p>
<p><a href="/cs/pa3.c" title="pa3.c">pa3.c</a> my solution</p>
<div class="highlight"><pre><code class="c"><span class="cm">/* </span>
<span class="cm"> * Will Mernagh Mar 2007 </span>
<span class="cm"> * PA3</span>
<span class="cm"> * Mar 2007</span>
<span class="cm"> */</span>

<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;netinet/ip.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;netinet/tcp.h&gt;</span>
<span class="cp">#include &lt;netinet/udp.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cm">/* based on the background info and attack files these are the tresholds </span>
<span class="cm"> * These numbers could be made better with more data </span>
<span class="cm"> */</span>
<span class="cp">#define ALLOWED_RST 100</span>
<span class="cp">#define MAX_ALLOWED_IP 70</span>
<span class="cp">#define MAX_ALLOWED_PORTS 75</span>
<span class="cp">#define RESET_COUNT 500</span>

<span class="cm">/* linked list of ports this is needed to count the number of different ports */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ports</span> <span class="n">port_list</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">port_list</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* a linked list of hosts - for counting different hosts by IP */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">host_info</span> <span class="n">host</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">host</span><span class="p">{</span>
    <span class="kt">char</span> <span class="n">ip_addr</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_of_ports</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* an event counter. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcp_flag_event_counter</span> <span class="n">tcp_event_counter</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">num_of_events</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_of_source</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_of_dest</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_dest_ports</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_source_ports</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_of_packets_less_events</span><span class="p">;</span> <span class="cm">/* since first event num_of_packets_less_events*/</span>
<span class="p">};</span>

<span class="cm">/* function prototypes */</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span> <span class="n">check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcpheader</span><span class="p">,</span> 
                            <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ipheader</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span> <span class="n">parse_input</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">decode_tcp_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">urg</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ack</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">psh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rst</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">syn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fin</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">print_usage</span><span class="p">();</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span> <span class="n">increment_Event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="p">,</span> 
                                           <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">free_event_nodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">print_type_of_attack</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">);</span>


<span class="cm">/* function implementations */</span>

<span class="cm">/* check_events()</span>
<span class="cm">*</span>
<span class="cm">* This function takes in a tcphdr struct and decides if an searched for event</span>
<span class="cm">* occured. It just looks for RST but can be easily modified for others</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="nf">check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcpheader</span><span class="p">,</span> 
                <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ipheader</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">rst_search</span><span class="p">,</span> <span class="o">*</span><span class="n">syn_search</span><span class="p">,</span> <span class="o">*</span><span class="n">syn_ack_search</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">synstr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;SYN&quot;</span><span class="p">,</span> <span class="n">rststr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;RST&quot;</span><span class="p">,</span> <span class="n">synackstr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;SYN ACK&quot;</span><span class="p">;</span> 

    <span class="n">decode_tcp_flags</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">urg</span><span class="p">,</span> <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">,</span>  
                <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">psh</span><span class="p">,</span> <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">,</span> <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">,</span> <span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">);</span>

    <span class="n">rst_search</span> <span class="o">=</span> <span class="n">rststr</span><span class="p">;</span>
    <span class="n">syn_search</span> <span class="o">=</span> <span class="n">synstr</span><span class="p">;</span>
    <span class="n">syn_ack_search</span> <span class="o">=</span> <span class="n">synackstr</span><span class="p">;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

    <span class="cm">/* search for different types of events </span>
<span class="cm">     * Type 1: Large num of RST + Small set of IPs + Large set of ports </span>
<span class="cm">     * Type 2: Large num of RST + Large num of Ips + Small num of ports</span>
<span class="cm">     * Type 3: Large number of SYN ACK with no corresponding ACK </span>
<span class="cm">     *           This type will not be checked for here because we will determin</span>
<span class="cm">     *           the info from RST</span>
<span class="cm">     */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">rst_search</span><span class="p">);</span>

    <span class="cm">/* If RST increment event counter */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">ig_event_counter</span> <span class="o">=</span> <span class="n">increment_Event</span><span class="p">(</span><span class="n">tcpheader</span><span class="p">,</span><span class="n">ipheader</span><span class="p">,</span> <span class="n">ig_event_counter</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ig_event_counter</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* decode_tcp_flags()</span>
<span class="cm">*</span>
<span class="cm">* This function takes in all the flags from a tcp struct and prints</span>
<span class="cm">* which flags are set as a string.  It outputs the string to the </span>
<span class="cm">* buffer parameter.  This buffer needs to be at least 25 chars in length.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">decode_tcp_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> 
                      <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">urg</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ack</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">psh</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rst</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">syn</span><span class="p">,</span> 
                      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>        <span class="c1">// clear buffer</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">syn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SYN &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">urg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;URG &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ACK &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">psh</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;PSH &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rst</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;RST &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fin</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;FIN &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* parse_input()</span>
<span class="cm"> *</span>
<span class="cm"> * Given the trace file name and path, opens the file and reads in the </span>
<span class="cm"> * data line by line.  Each line corresponds to one packet, so the hex</span>
<span class="cm"> * characters in each line are converted to an array of binary values.</span>
<span class="cm"> * The ip and tcphdr structs are applied to the data array, </span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="nf">parse_input</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> 
                                    <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">tracefile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
    <span class="kt">ssize_t</span> <span class="n">bytes_read</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">packetnum</span><span class="p">,</span> <span class="n">input2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">shortarr</span><span class="p">[</span><span class="mi">66000</span><span class="p">];</span>        <span class="c1">// max packet length is 2^16</span>
    <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ipheader</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcpheader</span><span class="p">;</span>

    <span class="cm">/* open file for reading */</span>
    <span class="n">tracefile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tracefile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: input file %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* allocate buffer space */</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nbytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* input loop */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bytes_read</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">tracefile</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
            <span class="cm">/* only parse valid data */</span>
    
            <span class="kt">char</span> <span class="n">ok_chars</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;0123456789 abcdef ABCDEF&quot;</span><span class="p">;</span>
            <span class="cm">/* minus 2 for end of file and end of line */</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">strspn</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">ok_chars</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: Invalid file. &quot;</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The file should only contain hex and white spaces</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> 
            <span class="p">}</span>
    
            <span class="cm">/* get rid of line number */</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
            <span class="n">sscanf</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packetnum</span><span class="p">);</span>
    
            <span class="k">while</span> <span class="p">((</span><span class="n">curr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        
                <span class="cm">/* translate line into array of 16-bit values */</span>
                <span class="n">sscanf</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input2</span><span class="p">);</span>
        
                <span class="cm">/* put input into network byte order.  we do this so we can</span>
<span class="cm">                * use the helper functions defined in the netinet</span>
<span class="cm">                * package. */</span>
                <span class="n">shortarr</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">input2</span><span class="p">);</span>
                <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        
            <span class="p">}</span>
    
            <span class="cm">/* process short array */</span>
            <span class="n">ipheader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="p">)</span><span class="n">shortarr</span><span class="p">;</span>
            <span class="n">tcpheader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">shortarr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_hl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
    
            <span class="cm">/* We only want TCP packets */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_p</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
        
        
                <span class="cm">/* check for RST events */</span>
                <span class="n">ig_event_counter</span> <span class="o">=</span> <span class="n">check_events</span><span class="p">(</span><span class="n">tcpheader</span><span class="p">,</span> <span class="n">ipheader</span><span class="p">,</span> 
                                                <span class="n">ig_event_counter</span><span class="p">);</span>
                <span class="cm">/* after first RST count all packets */</span>
                <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
                    <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_packets_less_events</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
            
                    <span class="cm">/* if RST went over limit */</span>
                    <span class="k">if</span><span class="p">((</span><span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ALLOWED_RST</span><span class="p">){</span>
                
                        <span class="cm">/* print type of attack (if one) */</span>
                        <span class="n">print_type_of_attack</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="p">);</span>
                        <span class="cm">/* clean up */</span>
                        <span class="n">fclose</span><span class="p">(</span><span class="n">tracefile</span><span class="p">);</span>
                        <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">ig_event_counter</span><span class="p">;</span>
                
                    <span class="cm">/* if enough good events then clear RST counter */</span>    
                    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_packets_less_events</span> <span class="o">&gt;</span> <span class="n">RESET_COUNT</span><span class="p">){</span>
                        <span class="n">free_event_nodes</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="p">);</span>
                        <span class="n">ig_event_counter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="p">}</span>
                
                <span class="p">}</span>
        
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* clean up */</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">tracefile</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
    <span class="cm">/* if no detected attack free counter */</span>
    <span class="n">free_event_nodes</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ig_event_counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* print_usage()</span>
<span class="cm"> *</span>
<span class="cm"> * Prints usage information for the program to stdout</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">print_usage</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: attackalarm FILE</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* main()</span>
<span class="cm"> *</span>
<span class="cm"> * Checks arguments, sets options, and does the work.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">infilename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">;</span>
    <span class="n">ig_event_counter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 

    <span class="cm">/* check for at least 1 command-line option */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: required parameter missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">print_usage</span><span class="p">();</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="c1">// assume this is the input filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">infilename</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">infilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: unexpected argument: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">print_usage</span><span class="p">();</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">infilename</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: required parameter missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">print_usage</span><span class="p">();</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* parse input and count events */</span>
    <span class="n">ig_event_counter</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">infilename</span><span class="p">,</span> <span class="n">ig_event_counter</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;No scan detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="cm">/* free the event counter */</span>
        <span class="n">free_event_nodes</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/* If we get a EVENT this fun gets called and increments the relavant info</span>
<span class="cm"> * </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">increment_Event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcpheader</span><span class="p">,</span> 
                                    <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ipheader</span><span class="p">,</span> 
                                    <span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">event_counter</span><span class="p">){</span>

    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">stored_host</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* 0 = source, 1 = dest */</span>

    <span class="cm">/* initialize rstcounter  */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">event_counter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span>
                                <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_source</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_dest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_events</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host</span><span class="p">));</span>

        <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">num_of_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span>
                                                    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span><span class="p">));</span>

        <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">strncpy</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_src</span><span class="p">),</span> 
                                        <span class="n">strlen</span><span class="p">(</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_src</span><span class="p">)));</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_source_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host</span><span class="p">));</span>

        <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">num_of_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span>
                                                            <span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span><span class="p">));</span>

        <span class="k">if</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">strncpy</span><span class="p">(</span><span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_dst</span><span class="p">),</span> 
                                        <span class="n">strlen</span><span class="p">(</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_dst</span><span class="p">)));</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>        
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_dest_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_packets_less_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                                     
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>

        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_events</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">current_ip</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">current_port</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">stored_host</span> <span class="o">=</span> <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
                <span class="n">current_ip</span> <span class="o">=</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_src</span><span class="p">);</span>
                <span class="n">current_port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">stored_host</span> <span class="o">=</span> <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
                <span class="n">current_ip</span> <span class="o">=</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ipheader</span><span class="o">-&gt;</span><span class="n">ip_dst</span><span class="p">);</span>
                <span class="n">current_port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcpheader</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>
            <span class="p">}</span>
     
            <span class="cm">/* check if we have source and increment it if we do */</span>
            <span class="c1">//printf(&quot;Is %s == \n&quot;, current_ip);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">stored_host</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>

                <span class="cm">/* check against current */</span>
                <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">current_ip</span><span class="p">,</span> <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span>
                                                <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>

                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
            
                    <span class="cm">/* if we have source check if we have port */</span>
                    <span class="k">while</span><span class="p">(</span><span class="n">port</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">current_port</span><span class="p">){</span>
                            <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                            <span class="cm">/* keep count of ports */</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                                <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_source_ports</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                                <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_dest_ports</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span> 
                                                    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span><span class="p">));</span>
                    
                            <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                            <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* don&#39;t know why I need this */</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">current_port</span><span class="p">;</span>
                            <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                            <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">num_of_ports</span><span class="o">++</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                            <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="p">}</span>
                
                    <span class="p">}</span>
            
                    <span class="n">stored_host</span> <span class="o">=</span> <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                   
                <span class="cm">/* if new source then store it */</span>
                <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            
                    <span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_source</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="n">event_counter</span><span class="o">-&gt;</span><span class="n">num_of_dest</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
            
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span>
                                                                <span class="k">struct</span> <span class="n">host</span><span class="p">));</span>
                    <span class="n">stored_host</span> <span class="o">=</span> <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            
                    <span class="k">if</span><span class="p">(</span><span class="n">stored_host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>
            
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">num_of_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span>
                                                            <span class="k">struct</span> <span class="n">port_list</span><span class="p">));</span>
            
                    <span class="k">if</span><span class="p">(</span><span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: malloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>
            
                    <span class="n">strncpy</span><span class="p">(</span><span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">current_ip</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span>
                                                                <span class="n">current_ip</span><span class="p">));</span>
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">current_port</span><span class="p">;</span>
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                    
            
                    <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Don&#39;t know why */</span>
                    <span class="k">break</span><span class="p">;</span>
            
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="n">stored_host</span> <span class="o">=</span> <span class="n">stored_host</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="cm">/* for loop */</span>
                
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">event_counter</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/* This needs to recurse through the linked lists and free the memory */</span>
<span class="kt">void</span> <span class="n">free_event_nodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">){</span>
    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">source_free</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_free</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">port_list</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">port_free</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>

        <span class="n">dest</span> <span class="o">=</span> <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="n">dest</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>

            <span class="n">port</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
    
            <span class="k">while</span><span class="p">(</span><span class="n">port</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        
                <span class="n">port_free</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">free</span><span class="p">(</span><span class="n">port_free</span><span class="p">);</span>
        
            <span class="p">}</span>
    
            <span class="n">dest_free</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">free</span><span class="p">(</span><span class="n">dest_free</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="n">source</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
    
            <span class="n">port</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
    
            <span class="k">while</span><span class="p">(</span><span class="n">port</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        
                <span class="n">port_free</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">free</span><span class="p">(</span><span class="n">port_free</span><span class="p">);</span>
        
            <span class="p">}</span>
    
            <span class="n">source_free</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">free</span><span class="p">(</span><span class="n">source_free</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">free</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="n">print_type_of_attack</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_event_counter</span> <span class="o">*</span><span class="n">ig_event_counter</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">source_itr</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_itr</span><span class="p">;</span>

        <span class="n">source_itr</span> <span class="o">=</span> <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">source_itr</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="n">source_itr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
    
            <span class="cm">/* find largest source creating event */</span>
            <span class="k">if</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">source_itr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">){</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">source_itr</span><span class="p">;</span>
            <span class="p">}</span>
    
            <span class="n">source_itr</span> <span class="o">=</span> <span class="n">source_itr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">dest_itr</span> <span class="o">=</span> <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">dest_itr</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="n">dest_itr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
    
            <span class="cm">/* find largest source creating event */</span>
            <span class="k">if</span><span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">dest_itr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">){</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">dest_itr</span><span class="p">;</span>
            <span class="p">}</span>
    
            <span class="n">dest_itr</span> <span class="o">=</span> <span class="n">dest_itr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="cm">/* check for port scan */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">num_of_ports</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_PORTS</span> <span class="o">&amp;&amp;</span> <span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_dest</span> <span class="o">&lt;</span> <span class="n">MAX_ALLOWED_IP</span><span class="p">){</span>
    
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Port scan detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Source host: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destination host: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
    
        <span class="cm">/* check for SYN flood to closed port */</span>    
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_dest</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_IP</span><span class="p">){</span>
    
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SYN flood detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Source host: spoofed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destination host: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
    
        <span class="cm">/* check for SYN Flood to open port */</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ig_event_counter</span><span class="o">-&gt;</span><span class="n">num_of_source</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_IP</span><span class="p">){</span>
    
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SYN flood detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Source host: spoofed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destination host: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
    
        <span class="p">}</span>

<span class="p">}</span>
</code></pre>
</div>
  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'willspics'; 
    var disqus_developer = 1; // developer mode is on

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    //var disqus_identifier = '';
    //var disqus_url = 'http://will.willandorla.com/2007/03/network-attack-detection';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</div>

<div id="boastful">
  <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="im_a_muppet">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
</div>


<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
	try {
		var pageTracker = _gat._getTracker("UA-10956030-4");
		pageTracker._trackPageview();
		} catch(err) {}</script>

</body>
</html>
